name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare deployment files
      run: |
        # Create a temporary directory for deployment
        mkdir deploy-temp
        # Copy necessary files, excluding unnecessary ones
        rsync -av --exclude='.git' \
                  --exclude='node_modules' \
                  --exclude='.DS_Store' \
                  --exclude='deploy-temp' \
                  --exclude='.gitignore' \
                  --exclude='dist' \
                  . deploy-temp/

    - name: Deploy to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: 194.195.92.198
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        source: "deploy-temp/*"
        target: "/root/supercrawler"
        strip_components: 1
        overwrite: true
        rm: true

    - name: Setup and run on server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 194.195.92.198
        username: root
        password: ${{ secrets.SERVER_PASSWORD }}
        script: |
          cd /root/supercrawler

          # Create .env file with secrets
          cat > .env << EOF
          NODE_ENV=production
          REDIS_URL=redis://redis:6379
          PORT=3000
          HOST=${{ secrets.HOST }}
          API_KEY=${{ secrets.API_KEY }}
          EOF

          # Install Docker Compose if not exists
          if ! command -v docker-compose &> /dev/null; then
            echo "Installing Docker Compose..."
            curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            chmod +x /usr/local/bin/docker-compose
          fi

          # Stop existing containers
          docker-compose down 2>/dev/null || true

          # Remove old images to free space
          docker system prune -f

          # Build and start services
          docker-compose up -d --build

          # Wait for services to be ready
          sleep 10

          # Show status
          docker-compose ps

          # Show logs for each service
          echo "=== Traefik logs ==="
          docker-compose logs --tail=50 traefik
          echo "=== Web logs ==="
          docker-compose logs --tail=50 web
          echo "=== Redis logs ==="
          docker-compose logs --tail=50 redis

          echo "Deployment completed successfully!"
          echo "Access your application at: https://${{ secrets.HOST }}"

    - name: Display deployment info
      run: |
        echo "‚úÖ Deployment completed!"
        echo "üåê Application URL: https://${{ secrets.HOST }}"
        echo "üìä Traefik Dashboard: http://194.195.92.198:8080"